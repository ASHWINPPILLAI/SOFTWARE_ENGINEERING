<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus Tracker</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#e0f2fe,#fef9c3);margin:0;}
header{background:#1e3a8a;color:#fff;padding:15px;text-align:center;font-weight:bold;font-size:20px;}
.container{max-width:720px;margin:20px auto;padding:15px;}
h2{text-align:center;color:#1e3a8a;margin-bottom:15px;}
h3{color:#1e3a8a;}
.panel{background:#fff;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 6px 15px rgba(0,0,0,0.08);}
button{padding:8px 14px;margin:6px 4px;cursor:pointer;border:none;border-radius:6px;font-weight:600;}
.btn-green{background:#16a34a;color:#fff}.btn-green:hover{background:#15803d;}
.btn-red{background:#dc2626;color:#fff}.btn-red:hover{background:#b91c1c;}
.btn-blue{background:#2563eb;color:#fff}.btn-blue:hover{background:#1d4ed8;}
input, select{padding:10px;width:100%;margin:6px 0;border:1px solid #ccc;border-radius:6px;font-size:14px; box-sizing: border-box;}
.progress-bar{background:#e5e7eb;border-radius:6px;overflow:hidden;height:18px;margin-top:5px;}
.progress{height:100%;background:#34d399;transition:width 0.3s;}
#crowdLevel{font-weight:bold;}
.offline{color:#9a3412;font-weight:bold;}
footer{text-align:center;font-size:13px;color:#555;margin:20px 0;}
#busMap{width:100%; height:400px; border-radius:12px; margin-top:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1);}

/* --- STYLES for DEMO & TRACKING --- */
#adminAlerts { background: #e9ecef; padding: 10px; border-radius: 5px; margin-top: 10px; min-height: 150px; overflow-y: auto; max-height: 250px;}
.alert-card { padding: 8px; border-radius: 5px; margin-bottom: 8px; color: white; transition: all 0.3s ease; }
.alert-sos { background-color: #dc3545; border-left: 5px solid #a71d2a; animation: pulse-red 1s infinite; }
.alert-info { background-color: #17a2b8; border-left: 5px solid #117a8b; } /* Style for police notification */
.alert-deviation { background-color: #ffc107; color: black; border-left: 5px solid #c69500; }
.alert-safe { background-color: #28a745; border-left: 5px solid #1e7e34; }

#trackingControls button { margin: 5px 0; width: 100%; }
#sosButton { background-color: #dc3545; color: white; }
#sosButton:hover { background-color: #c82333; }
#forceDeviationButton { background-color: #ffc107; color: black;}
#returnRouteButton { background-color: #28a745; color: white; }
#sosConfirmation { color: #dc3545; font-weight: bold; text-align: center; margin-top: 5px; display: none; } /* For pilot confirmation */


@keyframes pulse-red {
Â  0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
Â  70% { transform: scale(1.02); box-shadow: 0 0 10px 10px rgba(220, 53, 69, 0); }
Â  100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}
</style>
</head>
<body>

<header>ğŸš Smart Bus Tracker</header>

<!-- Login Page -->
<div class="container" id="loginPage">
Â  <h2>Welcome</h2>
Â  <div class="panel">
Â  Â  <h3>Pilot Login</h3>
Â  Â  <input type="text" id="username" placeholder="Username">
Â  Â  <input type="password" id="password" placeholder="Password">
    <!-- ADDED LOGIN ERROR MESSAGE -->
Â  Â  <p id="loginError" style="color:red; display:none; text-align: center; margin: 5px 0;"></p>
Â  Â  <button class="btn-green" onclick="loginPilot()">Login as Pilot</button>
Â  </div>
Â  <div class="panel">
Â  Â  <h3>Passenger Access</h3>
Â  Â  <button class="btn-blue" onclick="enterPassenger()">Enter as Passenger</button>
Â  </div>
</div>

<!-- Dashboard -->
<div class="container" id="dashboard" style="display:none;">
Â  <h2 id="roleTitle"></h2>

Â  <!-- Bus Info -->
Â  <div class="panel">
Â  Â  <h3>Bus Info</h3>
Â  Â  <p>Current Stop: <span id="currentStop">Stop 1</span></p>
Â  Â  <p>Next Stop: <span id="nextStop">Stop 2</span></p>
Â  Â  <p>Next Bus Arrival: <span id="nextBus">--:--</span></p>
Â  Â  <p class="offline">Estimated Location: <span id="estimatedLoc">--</span></p>
Â  Â  <div id="pilotControlsBus">
Â  Â  Â  <input type="text" id="setCurrentStop" placeholder="Set Current Stop">
Â  Â  Â  <input type="text" id="setNextStop" placeholder="Set Next Stop">
Â  Â  Â  <input type="text" id="setNextBus" placeholder="Set Next Bus Time (HH:MM)">
Â  Â  Â  <input type="number" id="setSpeed" placeholder="Set Bus Speed (km/h)">
Â  Â  Â  <input type="number" id="setDistance" placeholder="Distance to Next Stop (km)">
Â  Â  Â  <button class="btn-green" onclick="updateBusInfo()">Update Bus Info</button>
Â  Â  </div>
Â  </div>

Â  <!-- Seats -->
Â  <div class="panel">
Â  Â  <h3>Seats / Crowd Level</h3>
Â  Â  <p>Total Seats: <span id="totalSeats">30</span></p>
Â  Â  <p>Occupied: <span id="occupiedSeats">8</span></p>
Â  Â  <p>Available: <span id="availableSeats">22</span></p>
Â  Â  <div class="progress-bar"><div class="progress" id="seatProgress" style="width:26.6%"></div></div>
Â  Â  <p>Crowd Level: <span id="crowdLevel">Low</span></p>
Â  Â  <div id="pilotControlsSeats">
Â  Â  Â  <button id="plusSeat" class="btn-green">+</button>
Â  Â  Â  <button id="minusSeat" class="btn-red">-</button>
Â  Â  </div>
Â  </div>

Â  <!-- Wheelchair -->
Â  <div class="panel">
Â  Â  <h3>Wheelchair Accessibility</h3>
Â  Â  <p>Wheelchair Space: <span id="wheelchairStatus">Available</span></p>
Â  Â  <div id="wheelchairControls">
Â  Â  Â  <button id="reserveWC" class="btn-green">Reserve Wheelchair</button>
Â  Â  Â  <button id="releaseWC" class="btn-red">Release Wheelchair</button>
Â  Â  </div>
Â  </div>

Â  <!-- Network Mode -->
Â  <div class="panel">
Â  Â  <h3>Network Mode</h3>
Â  Â  <p>Status: <span id="networkStatus" style="font-weight:bold;color:green;">Online</span></p>
Â  Â  <button class="btn-blue" onclick="toggleNetwork()">Toggle Online/Offline</button>
Â  </div>

Â  <!-- Live Map -->
Â  <div class="panel">
Â  Â  <h3>Live Tracking</h3>
Â  Â  <label for="busSelector">Select a Bus to Track:</label>
Â  Â  <select id="busSelector">
Â  Â  Â  <option value="">-- Select Bus --</option>
Â  Â  </select>
Â  Â  <div id="busMap"></div>
Â  </div>
Â  
Â  <!-- Tracking Controls (Pilot Only) -->
Â  <div class="panel" id="trackingControls" style="display:none;">
Â  Â  <h3>Tracking Demo Controls</h3>
Â  Â  <button id="sosButton">ğŸš¨ TRIGGER SOS</button>
    <!-- ADDED SOS CONFIRMATION MESSAGE -->
    <p id="sosConfirmation"></p>
Â  Â  <button id="forceDeviationButton">âš ï¸ Force Route Deviation</button>
Â  Â  <button id="returnRouteButton">âœ… Return to Route</button>
Â  </div>

Â  <!-- Admin Alerts (Pilot Only) -->
Â  <div class="panel" id="adminPanel" style="display:none;">
Â  Â  <h3>Admin Alerts</h3>
Â  Â  <div id="adminAlerts"><p><i>Alerts will appear here...</i></p></div>
Â  </div>

Â  <button class="btn-red" onclick="logout()">Logout</button>
</div>

<footer>Â© 2025 Smart Bus Tracker | SIH Demo</footer>

<script>
let occupiedSeats=8,TOTAL_SEATS=30;
let wheelchairAvailable=true;
let role="";
let busSpeed=20,routeDistance=5,lastUpdateTime=new Date();
let currentStopName="Stop 1",nextStopName="Stop 2";
let isOnline=true;

// Elements
const currentStopEl=document.getElementById('currentStop');
const nextStopEl=document.getElementById('nextStop');
const nextBusEl=document.getElementById('nextBus');
const occupiedEl=document.getElementById('occupiedSeats');
const availableEl=document.getElementById('availableSeats');
const seatProgEl=document.getElementById('seatProgress');
const crowdLevelEl=document.getElementById('crowdLevel');
const wheelchairStatusEl=document.getElementById('wheelchairStatus');
const estimatedLocEl=document.getElementById('estimatedLoc');
const networkStatusEl=document.getElementById('networkStatus');
const adminAlertsDiv = document.getElementById("adminAlerts");
const busSelector = document.getElementById("busSelector");
const sosConfirmationEl = document.getElementById("sosConfirmation"); // Get SOS confirmation element

// ------------------ Map Setup ------------------
let map = L.map('busMap').setView([11.0168,76.9558], 11); // Center of Coimbatore
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
Â  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

// --- ADVANCED MAP & TRACKING ---

// Bus Icons
const selectedIcon = L.divIcon({ html:'<div style="font-size:36px;">ğŸšŒ</div>', className:'', iconSize:[60,60], iconAnchor:[30,30] });
const sosIcon = L.divIcon({ html:'<div style="font-size:36px; animation: pulse-red 1s infinite;">ğŸš¨</div>', className:'', iconSize:[60,60], iconAnchor:[30,30] });
const deviatedIcon = L.divIcon({ html:'<div style="font-size:36px;">âš ï¸</div>', className:'', iconSize:[60,60], iconAnchor:[30,30] });

// Sample Buses with full data
let buses = [
Â  { id:1, name:"Bus A1 (Gandhipuram)", routeStops:[ {name:"Gandhipuram", lat:11.0183, lng:76.9686},{name:"Ukkadam",lat:10.9915,lng:76.9669}], seats:15, womenOnly:false, accessible:true, reservedSeats:2, lat:11.0183,lng:76.9686, eta:10, isDeviated: false, sosActive: false, geofence: [[10.98, 76.95], [11.03, 76.95], [11.03, 76.98], [10.98, 76.98]] },
Â  { id:2, name:"Bus C1 (RS Puram)", routeStops:[ {name:"RS Puram",lat:11.0056,lng:76.9568},{name:"Gandhipuram",lat:11.0183,lng:76.9686}], seats:12, womenOnly:true, accessible:true, reservedSeats:4, lat:11.0056,lng:76.9568, eta:8, isDeviated: false, sosActive: false, geofence: [[10.99, 76.94], [11.03, 76.94], [11.03, 76.98], [10.99, 76.98]] },
Â  { id:3, name:"Bus D1 (Saibaba Kovil)", routeStops:[ {name:"Saibaba Kovil",lat:11.0260,lng:76.9515},{name:"Town Hall",lat:10.9971,lng:76.9689}], seats:20, womenOnly:true, accessible:false, reservedSeats:0, lat:11.0260,lng:76.9515, eta:12, isDeviated: false, sosActive: false, geofence: [[10.98, 76.94], [11.04, 76.94], [11.04, 76.98], [10.98, 76.98]] }
];

// State variables
let currentBus = null;
let currentMarker = null;
let currentGeofenceLayer = null;
let currentPolylineLayer = null;

// Add buses to dropdown
buses.forEach(bus => {
Â  const option = document.createElement('option');
Â  option.value = bus.id;
Â  option.textContent = bus.name;
Â  busSelector.appendChild(option);
});
busSelector.onchange = () => {
Â  const selectedId = parseInt(busSelector.value);
Â  const bus = buses.find(b => b.id === selectedId);
Â  if (bus) {
Â  Â  showSelectedBus(bus);
Â  } else {
Â  Â  clearMap();
Â  }
};

// --- Tracking Helper Functions ---

function addAdminAlert(bus, type, message = '') { // Added optional message parameter
Â  Â  if (adminAlertsDiv.querySelector("p")) adminAlertsDiv.innerHTML = "";
Â  Â  const alert = document.createElement('div');
Â  Â  const time = new Date().toLocaleTimeString();
Â  Â  if (type === 'SOS') {
Â  Â  Â  Â  alert.className = 'alert-card alert-sos';
Â  Â  Â  Â  alert.innerHTML = `<strong>SOS!</strong> ${bus.name} triggered panic button at ${time}.`;
Â  Â  } else if (type === 'DEVIATION') {
Â  Â  Â  Â  alert.className = 'alert-card alert-deviation';
Â  Â  Â  Â  alert.innerHTML = `<strong>DEVIATION!</strong> ${bus.name} went off-route at ${time}.`;
Â  Â  } else if (type === 'SAFE') {
Â  Â  Â  Â  alert.className = 'alert-card alert-safe';
Â  Â  Â  Â  alert.innerHTML = `<strong>SAFE:</strong> ${bus.name} is back on route at ${time}.`;
Â  Â  } else if (type === 'INFO') { // New type for police notification
        alert.className = 'alert-card alert-info';
        alert.innerHTML = `<strong>INFO:</strong> ${message} (${bus.name} at ${time}).`;
    }
Â  Â  adminAlertsDiv.prepend(alert);
}

function isPointInPolygon(point, polygon) {
Â  Â  let [lat, lng] = point;
Â  Â  let isInside = false;
Â  Â  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
Â  Â  Â  Â  let [pi_lat, pi_lng] = polygon[i];
Â  Â  Â  Â  let [pj_lat, pj_lng] = polygon[j];
        // *** TYPO WAS HERE: pj_png corrected to pj_lng ***
Â  Â  Â  Â  let intersect = ((pi_lng > lng) !== (pj_lng > lng)) && (lat < (pj_lat - pi_lat) * (lng - pi_lng) / (pj_lng - pi_lng) + pi_lat);
Â  Â  Â  Â  if (intersect) isInside = !isInside;
Â  Â  }
Â  Â  return isInside;
}

function checkGeofence(bus) {
Â  Â  if (!bus || bus.sosActive || !currentMarker) return;
Â  Â  const isInside = isPointInPolygon([bus.lat, bus.lng], bus.geofence);
Â  Â  if (!isInside && !bus.isDeviated) {
Â  Â  Â  Â  bus.isDeviated = true;
Â  Â  Â  Â  addAdminAlert(bus, 'DEVIATION');
Â  Â  Â  Â  currentMarker.setIcon(deviatedIcon);
Â  Â  } else if (isInside && bus.isDeviated) {
Â  Â  Â  Â  bus.isDeviated = false;
Â  Â  Â  Â  addAdminAlert(bus, 'SAFE');
Â  Â  Â  Â  currentMarker.setIcon(selectedIcon);
Â  Â  }
}

function clearMap() {
Â  Â  if(currentMarker) map.removeLayer(currentMarker);
Â  Â  if(currentGeofenceLayer) map.removeLayer(currentGeofenceLayer);
Â  Â  if(currentPolylineLayer) map.removeLayer(currentPolylineLayer);
Â  Â  currentBus = null;
Â  Â  currentMarker = null;
Â  Â  currentGeofenceLayer = null;
Â  Â  currentPolylineLayer = null;
    // Also reset the bus selector
    busSelector.value = "";
    // Clear SOS confirmation
    sosConfirmationEl.textContent = "";
    sosConfirmationEl.style.display = "none";
}

function showSelectedBus(bus){
Â  clearMap();
Â  currentBus = bus;

Â  // Create and draw layers for the selected bus
Â  let icon = selectedIcon;
Â  if (bus.sosActive) icon = sosIcon;
Â  else if (bus.isDeviated) icon = deviatedIcon;
Â 
Â  currentMarker = L.marker([bus.lat,bus.lng], {icon:icon}).addTo(map).bindPopup(bus.name);
Â  const latlngs = bus.routeStops.map(stop => [stop.lat, stop.lng]);
Â  currentPolylineLayer = L.polyline(latlngs, {color:'blue', weight:3, dashArray:'5,10'}).addTo(map);
Â  currentGeofenceLayer = L.polygon(bus.geofence, {color: '#ffc107', weight: 2, fillOpacity: 0.1}).addTo(map);
Â 
Â  map.fitBounds(currentGeofenceLayer.getBounds());
}

// --- Wire up Tracking Demo Buttons ---
document.getElementById('sosButton').onclick = () => {
Â  Â  Â  if (!currentBus || !currentMarker) return;
      if (currentBus.sosActive) return; // Prevent multiple triggers

Â  Â  Â  currentBus.sosActive = true;
Â  Â  Â  currentMarker.setIcon(sosIcon);
Â  Â  Â  addAdminAlert(currentBus, 'SOS');

      // *** ADDED: Simulate police notification ***
      addAdminAlert(currentBus, 'INFO', 'Route and details sent to nearest police station.');
      sosConfirmationEl.textContent = "SOS Activated! Authorities Notified.";
      sosConfirmationEl.style.display = "block";
      // Hide confirmation after a few seconds
      setTimeout(() => {
          sosConfirmationEl.style.display = "none";
      }, 5000); // 5 seconds
};
Â 
document.getElementById('forceDeviationButton').onclick = () => {
Â  Â  Â  if (!currentBus || !currentMarker) return;
Â  Â  Â  // Simulate moving outside the geofence
Â  Â  Â  currentBus.lat = currentBus.geofence[0][0] + 0.05;
Â  Â  Â  currentBus.lng = currentBus.geofence[0][1] + 0.05;
Â  Â  Â  currentMarker.setLatLng([currentBus.lat, currentBus.lng]);
Â  Â  Â  map.setView([currentBus.lat, currentBus.lng], 13);
Â  Â  Â  checkGeofence(currentBus);
};

document.getElementById('returnRouteButton').onclick = () => {
Â  Â  Â  if (!currentBus || !currentMarker) return;
Â  Â  Â  // Simulate returning to the route's start
Â  Â  Â  currentBus.lat = currentBus.routeStops[0].lat;
Â  Â  Â  currentBus.lng = currentBus.routeStops[0].lng;
Â  Â  Â  currentMarker.setLatLng([currentBus.lat, currentBus.lng]);
Â  Â  Â  map.setView([currentBus.lat, currentBus.lng], 13);
Â  Â  Â  if (currentBus.sosActive) {
          currentBus.sosActive = false;
          // Optionally add a 'SAFE' alert for SOS cleared?
          // addAdminAlert(currentBus, 'SAFE', 'SOS situation resolved.');
          sosConfirmationEl.textContent = ""; // Clear SOS confirmation
          sosConfirmationEl.style.display = "none";
      }
Â  Â  Â  checkGeofence(currentBus); // This will change icon back if deviated
      // Explicitly set icon back if it was SOS but not deviated
      if (!currentBus.isDeviated && !currentBus.sosActive) {
          currentMarker.setIcon(selectedIcon);
      }
};


// ------------------ Login / Logout ------------------
function loginPilot(){
Â  Â  const username=document.getElementById('username').value.trim();
Â  Â  const password=document.getElementById('password').value.trim();
    const errorEl = document.getElementById('loginError'); // Get error element

Â  Â  if(username==="pilot" && password==="1234"){
Â  Â  Â  Â  role="pilot";
Â  Â  Â  Â  document.getElementById('loginPage').style.display="none";
Â  Â  Â  Â  document.getElementById('dashboard').style.display="block";
Â  Â  Â  Â  document.getElementById('roleTitle').textContent="Pilot Dashboard";
Â  Â  Â  Â  // Show pilot controls
Â  Â  Â  Â  document.getElementById('pilotControlsBus').style.display="block";
Â  Â  Â  Â  document.getElementById('pilotControlsSeats').style.display="block";
Â  Â  Â  Â  document.getElementById('adminPanel').style.display="block";
Â  Â  Â  Â  document.getElementById('trackingControls').style.display="block";
Â  Â  Â  Â  document.querySelectorAll('#pilotControlsBus input').forEach(el=>el.disabled=false);
        errorEl.style.display = "none"; // Hide error on success

        // *** ADDED: Fix for map rendering ***
        setTimeout(() => map.invalidateSize(), 0);
Â  Â  } else {
        // Show error message instead of alert
        errorEl.textContent = "Invalid credentials! Use pilot / 1234";
        errorEl.style.display = "block";
    }
}

function enterPassenger(){
Â  Â  role="passenger";
Â  Â  document.getElementById('loginPage').style.display="none";
Â  Â  document.getElementById('dashboard').style.display="block";
Â  Â  document.getElementById('roleTitle').textContent="Passenger View";
Â  Â  // Hide pilot controls
Â  Â  document.getElementById('pilotControlsSeats').style.display="none";
Â  Â  document.getElementById('adminPanel').style.display="none";
Â  Â  document.getElementById('trackingControls').style.display="none";
Â  Â  document.querySelectorAll('#pilotControlsBus input').forEach(el=>el.disabled=true);
Â  Â  document.querySelector('#pilotControlsBus button').style.display="none";
    document.getElementById('loginError').style.display = "none";

    // *** ADDED: Fix for map rendering ***
    setTimeout(() => map.invalidateSize(), 0);
}

function logout(){
Â  Â  role="";
Â  Â  document.getElementById('dashboard').style.display="none";
Â  Â  document.getElementById('loginPage').style.display="block";
    document.getElementById('username').value = ""; // Clear fields
    document.getElementById('password').value = "";
Â  Â  clearMap(); // Clear the map on logout
}

// ------------------ Seats & Wheelchair ------------------
function updateSeats(){
Â  Â  occupiedEl.textContent=occupiedSeats;
Â  Â  availableEl.textContent=TOTAL_SEATS-occupiedSeats;
Â  Â  let pct=(occupiedSeats/TOTAL_SEATS)*100;
Â  Â  seatProgEl.style.width=pct+'%';
Â  Â  if(pct<=50){crowdLevelEl.textContent='Low';crowdLevelEl.style.color='green';}
Â  Â  else if(pct<=80){crowdLevelEl.textContent='Medium';crowdLevelEl.style.color='orange';}
Â  Â  else{crowdLevelEl.textContent='High';crowdLevelEl.style.color='red';}
}

function updateWheelchair(){
Â  Â  wheelchairStatusEl.textContent=wheelchairAvailable?'Available':'Not Available';
}

// Controls
document.getElementById('plusSeat').addEventListener('click',()=>{if(role==="pilot" && occupiedSeats<TOTAL_SEATS){occupiedSeats++;updateSeats();}});
document.getElementById('minusSeat').addEventListener('click',()=>{if(role==="pilot" && occupiedSeats>0){occupiedSeats--;updateSeats();}});
document.getElementById('reserveWC').addEventListener('click',()=>{wheelchairAvailable=false;updateWheelchair();});
document.getElementById('releaseWC').addEventListener('click',()=>{wheelchairAvailable=true;updateWheelchair();});

// ------------------ Bus Info ------------------
function updateBusInfo(){
Â  Â  if(role!=="pilot") return;
Â  Â  let c=document.getElementById('setCurrentStop').value;
Â  Â  let n=document.getElementById('setNextStop').value;
Â  Â  let t=document.getElementById('setNextBus').value;
Â  Â  let s=parseFloat(document.getElementById('setSpeed').value);
Â  Â  let d=parseFloat(document.getElementById('setDistance').value);
Â  Â  if(c){currentStopName=c; currentStopEl.textContent=c;}
Â  Â  if(n){nextStopName=n; nextStopEl.textContent=n;}
Â  Â  if(t) nextBusEl.textContent=t;
Â  Â  if(!isNaN(s)) busSpeed=s;
Â  Â  if(!isNaN(d)) routeDistance=d;
Â  Â  lastUpdateTime=new Date();
}

// ------------------ Network ------------------
function toggleNetwork(){
Â  Â  isOnline=!isOnline;
Â  Â  networkStatusEl.textContent=isOnline?"Online":"Offline";
Â  Â  networkStatusEl.style.color=isOnline?"green":"red";
Â  Â 
Â  Â  // When online, update the *real* bus position
Â  Â  if(isOnline && currentBus && currentMarker) {
Â  Â  Â  Â  currentMarker.setLatLng([currentBus.lat, currentBus.lng]);
Â  Â  Â  Â  map.panTo([currentBus.lat, currentBus.lng], {animate:true});
Â  Â  }
}

// ------------------ Estimate Location ------------------
function estimateLocation(){
Â  Â  if(isOnline){
Â  Â  Â  Â  estimatedLocEl.textContent="Live GPS Data Available";
Â  Â  Â  Â  estimatedLocEl.style.color="green";
Â  Â  Â  Â  // Live update logic for bus movement (replaces the old simulation)
Â  Â  Â  Â  if(currentBus && currentMarker && !currentBus.isDeviated && !currentBus.sosActive) {
Â  Â  Â  Â  Â  Â  // Simple simulation: move bus along its route
Â  Â  Â  Â  Â  Â  let startStop = currentBus.routeStops[0];
Â  Â  Â  Â  Â  Â  let endStop = currentBus.routeStops[1];

Â  Â  Â  Â  Â  Â  // Move 1% of the route per second (example movement)
Â  Â  Â  Â  Â  Â  let newLat = currentBus.lat + (endStop.lat - startStop.lat) * 0.01;
Â  Â  Â  Â  Â  Â  let newLng = currentBus.lng + (endStop.lng - startStop.lng) * 0.01;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  // Simple boundary check to reset
Â  Â  Â  Â  Â  Â  if (Math.abs(newLat - endStop.lat) < 0.001 || Math.abs(newLng - endStop.lng) < 0.001) { // Check both lat/lng proximity
Â  Â  Â  Â  Â  Â  Â  Â  currentBus.lat = startStop.lat;
Â  Â  Â  Â  Â  Â  Â  Â  currentBus.lng = startStop.lng;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  currentBus.lat = newLat;
Â  Â  Â  Â  Â  Â  Â  Â  currentBus.lng = newLng;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  currentMarker.setLatLng([currentBus.lat, currentBus.lng]);
Â  Â  Â  Â  Â  Â  // Only pan if the user hasn't manually moved the map recently
            // This requires more complex logic to track user interaction, skipping for simplicity
Â  Â  Â  Â  Â  Â  // map.panTo([currentBus.lat, currentBus.lng], {animate: true});
Â  Â  Â  Â  Â  Â  checkGeofence(currentBus); // Check geofence on every move
Â  Â  Â  Â  }
Â  Â  }
Â  Â  else { // This is the OFFLINE block
Â  Â  Â  Â  if(lastUpdateTime && busSpeed>0 && routeDistance>0){
Â  Â  Â  Â  Â  Â  let now=new Date();
Â  Â  Â  Â  Â  Â  let hours=(now-lastUpdateTime)/3600000;
Â  Â  Â  Â  Â  Â  let travelled=busSpeed*hours; // 'travelled' is correctly defined here
Â  Â  Â  Â  Â  Â  estimatedLocEl.style.color="#9a3412";
Â  Â  Â  Â  Â  Â  if(travelled>=routeDistance) estimatedLocEl.textContent=`Reached ${nextStopName}`;
Â  Â  Â  Â  Â  Â  else{
Â  Â  Â  Â  Â  Â  Â  Â  let pct=(travelled/routeDistance*100).toFixed(1);
Â  Â  Â  Â  Â  Â  Â  Â  estimatedLocEl.textContent=`${pct}% between ${currentStopName} and ${nextStopName}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else estimatedLocEl.textContent="--";
Â  Â  }
}

// ------------------ Init ------------------
updateSeats();
updateWheelchair();
setInterval(estimateLocation, 2000); // Check/update location more frequently
</script>
</body>
</html>

